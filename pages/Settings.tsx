
import React, { useState, useEffect, useRef } from 'react';
import { Card } from '../components/ui/Card';
import { User as UserIcon, Lock, Building, CreditCard, Percent, Upload, Save, Printer, FileDown, Plus, Edit2, ChevronDown, ChevronRight, Hash, Mail, MapPin, Phone, Trash2, Search, ArrowUpDown, Shield, CheckCircle, XCircle, ChevronLeft, AlertTriangle } from 'lucide-react';
import { useAuth } from '../context/AuthContext';
import { db } from '../services/mockDb';
import { DbUser, CompanyProfile, ChartOfAccount, AccountType, Role, TaxSetting, TaxType } from '../types';
import { Modal } from '../components/ui/Modal';
import { useNavigate } from 'react-router-dom';

const toProperCase = (str: string) => {
  return str.replace(/\w\S*/g, (txt) => txt.charAt(0).toUpperCase() + txt.substr(1).toLowerCase());
};

const formatNTN = (val: string) => { const clean = val.toUpperCase().replace(/[^A-Z0-9]/g, ''); return clean.length > 7 ? clean.slice(0, clean.length - 1) + '-' + clean.slice(clean.length - 1) : clean; };
const formatSTRN = (val: string) => { const clean = val.replace(/\D/g, ''); let f = clean; if (clean.length > 2) f = clean.slice(0, 2) + '-' + clean.slice(2); if (clean.length > 4) f = f.slice(0, 5) + '-' + clean.slice(4); if (clean.length > 8) f = f.slice(0, 10) + '-' + clean.slice(8); if (clean.length > 11) f = f.slice(0, 14) + '-' + clean.slice(11); return f.slice(0, 17); };
const formatCNIC = (val: string) => { const clean = val.replace(/\D/g, ''); let f = clean; if (clean.length > 5) f = clean.slice(0, 5) + '-' + clean.slice(5); if (clean.length > 12) f = f.slice(0, 13) + '-' + clean.slice(12); return f.slice(0, 15); };

const Settings = () => {
  const [activeTab, setActiveTab] = useState('profile');
  const { user: currentUser, updateUserCompany } = useAuth();
  const navigate = useNavigate();
  const isFirstRun = !currentUser?.companyId;

  useEffect(() => { if (isFirstRun && activeTab !== 'company') { setActiveTab('company'); } }, [isFirstRun, activeTab]);

  const [users, setUsers] = useState<DbUser[]>([]);
  const [userSearch, setUserSearch] = useState('');
  const [userSortField, setUserSortField] = useState<keyof DbUser>('name');
  const [userSortDirection, setUserSortDirection] = useState<'asc'|'desc'>('asc');
  const [userPage, setUserPage] = useState(1);
  const usersPerPage = 5;
  const [isUserModalOpen, setIsUserModalOpen] = useState(false);
  const [editingUser, setEditingUser] = useState<DbUser | null>(null);
  const [userFormData, setUserFormData] = useState({ name: '', email: '', password: '', role: 'user' as Role });
  const [userFormErrors, setUserFormErrors] = useState<Record<string, string>>({});
  
  const [companyProfile, setCompanyProfile] = useState<CompanyProfile>({ name: '', email: '', address: '', phone: '', ntn: '', strn: '', cnic: '', logoUrl: '', fiscalYearStart: new Date().getFullYear() + '-07-01' });
  const [companyErrors, setCompanyErrors] = useState<Partial<Record<keyof CompanyProfile, string>>>({});
  const [isSaving, setIsSaving] = useState(false);
  const fileInputRef = useRef<HTMLInputElement>(null);

  const [coa, setCoa] = useState<ChartOfAccount[]>([]);
  const [expandedRows, setExpandedRows] = useState<Record<string, boolean>>({});
  const [coaSearch, setCoaSearch] = useState('');
  const [isCoaModalOpen, setIsCoaModalOpen] = useState(false);
  const [editingAccount, setEditingAccount] = useState<ChartOfAccount | null>(null);
  const [newAccountParent, setNewAccountParent] = useState<ChartOfAccount | null>(null);
  const [accountFormData, setAccountFormData] = useState({ name: '', description: '' });

  const [taxes, setTaxes] = useState<TaxSetting[]>([]);
  const [isTaxModalOpen, setIsTaxModalOpen] = useState(false);
  const [editingTax, setEditingTax] = useState<TaxSetting | null>(null);
  const [taxFormData, setTaxFormData] = useState<Partial<TaxSetting>>({});

  useEffect(() => {
    if (!isFirstRun) {
        if (activeTab === 'users' && currentUser?.role === 'admin') setUsers(db.getUsers());
        if (activeTab === 'company') setCompanyProfile(db.getCompanyProfile());
        if (activeTab === 'chart_accounts') setCoa(db.getCOA());
        if (activeTab === 'tax') setTaxes(db.getTaxSettings());
    } else {
        if (activeTab === 'company') { setCompanyProfile(prev => ({ ...prev, email: currentUser?.email || '' })); }
    }
  }, [activeTab, currentUser, isFirstRun]);

  const filteredUsers = users.filter(u => u.name.toLowerCase().includes(userSearch.toLowerCase()) || u.email.toLowerCase().includes(userSearch.toLowerCase()) || u.role.includes(userSearch.toLowerCase()));
  const sortedUsers = [...filteredUsers].sort((a, b) => { const aVal = a[userSortField] || ''; const bVal = b[userSortField] || ''; return userSortDirection === 'asc' ? String(aVal).localeCompare(String(bVal)) : String(bVal).localeCompare(String(aVal)); });
  const totalUserPages = Math.ceil(sortedUsers.length / usersPerPage);
  const paginatedUsers = sortedUsers.slice((userPage - 1) * usersPerPage, userPage * usersPerPage);

  const handleUserSort = (field: keyof DbUser) => { if (userSortField === field) setUserSortDirection(prev => prev === 'asc' ? 'desc' : 'asc'); else { setUserSortField(field); setUserSortDirection('asc'); } };
  const openUserModal = (user?: DbUser) => { setEditingUser(user || null); setUserFormData(user ? { name: user.name, email: user.email, role: user.role, password: '' } : { name: '', email: '', password: '', role: 'user' }); setUserFormErrors({}); setIsUserModalOpen(true); };
  const saveUser = () => { const errors: Record<string, string> = {}; if (!userFormData.name) errors.name = 'Name is required'; if (!userFormData.email) errors.email = 'Email is required'; if (!editingUser && !userFormData.password) errors.password = 'Password is required'; if (userFormData.password && userFormData.password.length < 6) errors.password = 'Min 6 chars'; if (Object.keys(errors).length > 0) { setUserFormErrors(errors); return; } db.saveUser({ id: editingUser?.id, ...userFormData, companyId: currentUser?.companyId || null, passwordHash: userFormData.password ? userFormData.password : undefined }); setUsers(db.getUsers()); setIsUserModalOpen(false); };
  const deleteUser = (id: string) => { if (id === currentUser?.id) { alert("You cannot delete yourself."); return; } if (confirm("Are you sure? This action cannot be undone.")) { db.deleteUser(id); setUsers(db.getUsers()); } };

  const handleCompanyChange = (field: keyof CompanyProfile, value: string) => { let finalValue = value; if (field === 'ntn') finalValue = formatNTN(value); if (field === 'strn') finalValue = formatSTRN(value); if (field === 'cnic') finalValue = formatCNIC(value); setCompanyProfile(prev => ({ ...prev, [field]: finalValue })); if (companyErrors[field]) setCompanyErrors(prev => ({ ...prev, [field]: undefined })); };
  const handleCompanyBlur = (field: keyof CompanyProfile) => { if (field === 'name' || field === 'address') { setCompanyProfile(prev => ({ ...prev, [field]: toProperCase(prev[field] as string || '') })); } };
  const validateCompanyForm = () => { const errors: Partial<Record<keyof CompanyProfile, string>> = {}; if (!companyProfile.name.trim()) errors.name = 'Company Name is required'; if (!companyProfile.address.trim()) errors.address = 'Address is required'; if (companyProfile.email && !/^[^\s@]+@[^\s@]+\.[^\s@]+$/.test(companyProfile.email)) { errors.email = 'Invalid email address'; } if (companyProfile.ntn && !/^((?:[A-Z]\d{6}|\d{7})-\d)$/.test(companyProfile.ntn)) { errors.ntn = 'Invalid NTN'; } if (companyProfile.strn && !/^\d{2}-\d{2}-\d{4}-\d{3}-\d{2}$/.test(companyProfile.strn)) { errors.strn = 'Invalid STRN'; } if (companyProfile.cnic && !/^\d{5}-\d{7}-\d$/.test(companyProfile.cnic)) { errors.cnic = 'Invalid CNIC'; } setCompanyErrors(errors); return Object.keys(errors).length === 0; };
  const handleLogoUpload = (e: React.ChangeEvent<HTMLInputElement>) => { const file = e.target.files?.[0]; if (file) { const reader = new FileReader(); reader.onloadend = () => setCompanyProfile(prev => ({ ...prev, logoUrl: reader.result as string })); reader.readAsDataURL(file); } };
  const saveCompany = async () => { if (!validateCompanyForm()) return; setIsSaving(true); await new Promise(r => setTimeout(r, 1000)); if (isFirstRun) { try { const startDate = new Date(companyProfile.fiscalYearStart || new Date()); const newDbName = db.createCompanyDatabase(currentUser!.id, companyProfile.name, startDate); db.saveCompanyProfile(companyProfile); updateUserCompany(newDbName, companyProfile.name); navigate('/'); } catch (e: any) { alert('Setup failed: ' + e.message); } } else { db.saveCompanyProfile(companyProfile); } setIsSaving(false); };

  const toggleCoaRow = (id: string) => setExpandedRows(prev => ({ ...prev, [id]: !prev[id] }));
  const openAddAccountModal = (parent: ChartOfAccount | null) => { setEditingAccount(null); setNewAccountParent(parent); setAccountFormData({ name: '', description: '' }); setIsCoaModalOpen(true); };
  const openEditAccountModal = (account: ChartOfAccount) => { setEditingAccount(account); setNewAccountParent(null); setAccountFormData({ name: account.name, description: account.description || '' }); setIsCoaModalOpen(true); };
  const saveAccount = () => { if(!accountFormData.name) return; const newCode = newAccountParent ? db.generateNextCode(newAccountParent.id) : ''; if (editingAccount) { db.saveCOA({ ...editingAccount, name: accountFormData.name, description: accountFormData.description }); } else if (newAccountParent) { db.saveCOA({ code: newCode, name: accountFormData.name, description: accountFormData.description, level: (newAccountParent.level + 1) as any, parentId: newAccountParent.id, type: newAccountParent.type, isSystem: false }); setExpandedRows(prev => ({...prev, [newAccountParent.id]: true})); } setCoa(db.getCOA()); setIsCoaModalOpen(false); };
  const deleteAccount = (id: string) => { if(confirm("Are you sure?")) { try { db.deleteCOA(id); setCoa(db.getCOA()); } catch (e: any) { alert(e.message); } } };
  
  const handlePrint = (e: React.MouseEvent) => { 
      e.preventDefault();
      window.print(); 
  };
  const handleExportCSV = () => {  };
  
  const openTaxModal = (tax?: TaxSetting) => { setEditingTax(tax || null); setTaxFormData(tax ? { ...tax } : { name: '', type: 'GST', rate: 0, status: 'Active' }); setIsTaxModalOpen(true); };
  const saveTax = () => { if(!taxFormData.name || taxFormData.rate === undefined) return; db.saveTaxSetting(taxFormData); setTaxes(db.getTaxSettings()); setIsTaxModalOpen(false); };
  const deleteTax = (id: string) => { 
      if(confirm("Delete this tax setting?")) { 
          try { db.deleteTaxSetting(id); setTaxes(db.getTaxSettings()); } catch(e: any) { alert(e.message); }
      } 
  };

  const tabs = [{ id: 'profile', label: 'Profile', icon: UserIcon }, { id: 'company', label: 'Company', icon: Building }, { id: 'users', label: 'Users', icon: Lock }, { id: 'roles', label: 'Roles', icon: Shield }, { id: 'tax', label: 'Tax Settings', icon: Percent }, { id: 'chart_accounts', label: 'COA', icon: CreditCard }];

  return (
    <div className="space-y-6 pb-8">
       {isFirstRun && (<div className="bg-warning/10 border border-warning/20 p-4 rounded-xl flex items-center gap-3 animate-pulse no-print"><AlertTriangle className="text-warning" size={24} /><div><h3 className="font-bold text-warning">Action Required</h3><p className="text-sm text-text-muted">You must complete your Company Profile to initialize the system database.</p></div></div>)}
       <h1 className="text-2xl font-bold text-text-main tracking-tight no-print">Settings</h1>
       <div className="grid grid-cols-1 md:grid-cols-4 gap-8">
          <Card className="md:col-span-1 p-0 overflow-hidden h-fit border-border shadow-soft no-print"><div className="flex flex-col p-2 space-y-1">{tabs.map(tab => (<button key={tab.id} onClick={() => !isFirstRun && setActiveTab(tab.id)} disabled={isFirstRun && tab.id !== 'company'} className={`flex items-center gap-3 px-4 py-3 text-sm font-medium rounded-xl transition-all duration-200 ${activeTab === tab.id ? 'bg-primary/10 text-primary' : 'text-text-muted hover:bg-surface-highlight hover:text-text-main'} ${isFirstRun && tab.id !== 'company' ? 'opacity-50 cursor-not-allowed' : ''}`}><tab.icon size={18} />{tab.label}{isFirstRun && tab.id !== 'company' && <Lock size={12} className="ml-auto" />}</button>))}</div></Card>
          <div className="md:col-span-3">
             {activeTab === 'profile' && !isFirstRun && (<Card title="Profile Settings"><div className="space-y-6 max-w-lg"><div className="flex items-center gap-6"><img src={currentUser?.avatar} className="w-24 h-24 rounded-full border-4 border-surface shadow-md" alt="Profile" /><button className="text-sm font-medium text-primary hover:text-primary-light transition-colors border border-primary/20 px-4 py-2 rounded-lg hover:bg-primary/5">Change Avatar</button></div><div className="space-y-4"><div><label className="block text-xs font-semibold text-text-muted mb-1.5">Full Name</label><input type="text" defaultValue={currentUser?.name} className="w-full bg-surface-highlight border border-transparent rounded-xl p-3 text-text-main focus:border-primary/30 focus:outline-none focus:ring-4 focus:ring-primary/10 transition-all" /></div><div><label className="block text-xs font-semibold text-text-muted mb-1.5">Email</label><input type="email" defaultValue={currentUser?.email} disabled className="w-full bg-surface-highlight/50 border border-transparent rounded-xl p-3 text-text-muted cursor-not-allowed opacity-70" /></div><div><label className="block text-xs font-semibold text-text-muted mb-1.5">Organization Database</label><input type="text" defaultValue={currentUser?.companyId || 'None'} disabled className="w-full bg-surface-highlight/50 border border-transparent rounded-xl p-3 text-text-muted cursor-not-allowed opacity-70 font-mono" /></div><button className="bg-primary text-white px-6 py-2.5 rounded-xl font-medium mt-2 hover:bg-primary-light transition-all shadow-lg shadow-primary/20">Save Changes</button></div></div></Card>)}
             {activeTab === 'company' && (<Card title="Company Profile"><div className="space-y-8"><div className="flex flex-col sm:flex-row gap-8 items-start"><div className="w-full sm:w-1/3"><label className="block text-xs font-semibold text-text-muted mb-2">Company Logo</label><div onClick={() => fileInputRef.current?.click()} className={`relative border-2 border-dashed rounded-2xl h-48 flex flex-col items-center justify-center cursor-pointer transition-all overflow-hidden group ${companyProfile.logoUrl ? 'border-primary/50 bg-primary/5' : 'border-border hover:border-primary/50 hover:bg-surface-highlight'}`}>{companyProfile.logoUrl ? (<img src={companyProfile.logoUrl} alt="Logo" className="w-full h-full object-contain p-4" />) : (<div className="flex flex-col items-center text-center p-4"><Upload size={32} className="text-text-muted mb-3 opacity-50 group-hover:text-primary group-hover:opacity-100 transition-all" /><span className="text-xs font-medium text-text-muted">Click to upload logo</span><span className="text-[10px] text-text-muted/60 mt-1">PNG, JPG up to 2MB</span></div>)}<input type="file" ref={fileInputRef} className="hidden" accept="image/*" onChange={handleLogoUpload} /></div></div><div className="w-full sm:w-2/3 grid grid-cols-1 md:grid-cols-2 gap-5"><div className="md:col-span-2"><label className="block text-xs font-semibold text-text-muted mb-1.5">Company Name <span className="text-danger">*</span></label><div className="relative group"><Building className="absolute left-3 top-1/2 -translate-y-1/2 text-text-muted group-focus-within:text-primary transition-colors" size={16} /><input type="text" value={companyProfile.name} onChange={(e) => handleCompanyChange('name', e.target.value)} onBlur={() => handleCompanyBlur('name')} className={`w-full bg-surface-highlight border ${companyErrors.name ? 'border-danger' : 'border-transparent'} rounded-xl py-2.5 pl-10 pr-4 text-text-main focus:outline-none focus:border-primary/30 focus:ring-4 focus:ring-primary/10 transition-all`} /></div>{companyErrors.name && <span className="text-xs text-danger mt-1">{companyErrors.name}</span>}</div><div><label className="block text-xs font-semibold text-text-muted mb-1.5">Email Address</label><div className="relative group"><Mail className="absolute left-3 top-1/2 -translate-y-1/2 text-text-muted group-focus-within:text-primary transition-colors" size={16} /><input type="email" value={companyProfile.email} onChange={(e) => handleCompanyChange('email', e.target.value)} className={`w-full bg-surface-highlight border ${companyErrors.email ? 'border-danger' : 'border-transparent'} rounded-xl py-2.5 pl-10 pr-4 text-text-main focus:outline-none focus:border-primary/30 focus:ring-4 focus:ring-primary/10 transition-all`} /></div>{companyErrors.email && <span className="text-xs text-danger mt-1">{companyErrors.email}</span>}</div><div><label className="block text-xs font-semibold text-text-muted mb-1.5">Phone</label><div className="relative group"><Phone className="absolute left-3 top-1/2 -translate-y-1/2 text-text-muted group-focus-within:text-primary transition-colors" size={16} /><input type="text" value={companyProfile.phone || ''} onChange={(e) => handleCompanyChange('phone', e.target.value)} className="w-full bg-surface-highlight border border-transparent rounded-xl py-2.5 pl-10 pr-4 text-text-main focus:outline-none focus:border-primary/30 focus:ring-4 focus:ring-primary/10 transition-all" /></div></div><div><label className="block text-xs font-semibold text-text-muted mb-1.5">Fiscal Year Start</label><input type="date" value={companyProfile.fiscalYearStart || ''} onChange={(e) => setCompanyProfile(prev => ({...prev, fiscalYearStart: e.target.value}))} disabled={!isFirstRun} className={`w-full bg-surface-highlight border border-transparent rounded-xl py-2.5 px-4 text-text-main focus:outline-none focus:border-primary/30 ${!isFirstRun ? 'opacity-60 cursor-not-allowed' : ''}`}/></div><div className="md:col-span-2"><label className="block text-xs font-semibold text-text-muted mb-1.5">Address <span className="text-danger">*</span></label><div className="relative group"><MapPin className="absolute left-3 top-3 text-text-muted group-focus-within:text-primary transition-colors" size={16} /><textarea rows={2} value={companyProfile.address} onChange={(e) => handleCompanyChange('address', e.target.value)} onBlur={() => handleCompanyBlur('address')} className={`w-full bg-surface-highlight border ${companyErrors.address ? 'border-danger' : 'border-transparent'} rounded-xl py-2.5 pl-10 pr-4 text-text-main focus:outline-none focus:border-primary/30 focus:ring-4 focus:ring-primary/10 transition-all resize-none`} /></div>{companyErrors.address && <span className="text-xs text-danger mt-1">{companyErrors.address}</span>}</div><div className="md:col-span-2 pt-2 border-t border-border mt-2"><h4 className="text-sm font-bold text-text-main mb-4 flex items-center gap-2"><CreditCard size={16} className="text-primary"/> Tax & Identification</h4></div><div><label className="block text-xs font-semibold text-text-muted mb-1.5">NTN</label><div className="relative group"><Hash className="absolute left-3 top-1/2 -translate-y-1/2 text-text-muted group-focus-within:text-primary transition-colors" size={16} /><input type="text" value={companyProfile.ntn || ''} onChange={(e) => handleCompanyChange('ntn', e.target.value)} className={`w-full bg-surface-highlight border ${companyErrors.ntn ? 'border-danger' : 'border-transparent'} rounded-xl py-2.5 pl-10 pr-4 text-text-main focus:outline-none focus:border-primary/30 font-mono text-sm`} placeholder="A000000-0" /></div>{companyErrors.ntn && <span className="text-xs text-danger mt-1">{companyErrors.ntn}</span>}</div><div><label className="block text-xs font-semibold text-text-muted mb-1.5">STRN</label><div className="relative group"><Hash className="absolute left-3 top-1/2 -translate-y-1/2 text-text-muted group-focus-within:text-primary transition-colors" size={16} /><input type="text" value={companyProfile.strn || ''} onChange={(e) => handleCompanyChange('strn', e.target.value)} className={`w-full bg-surface-highlight border ${companyErrors.strn ? 'border-danger' : 'border-transparent'} rounded-xl py-2.5 pl-10 pr-4 text-text-main focus:outline-none focus:border-primary/30 font-mono text-sm`} placeholder="00-00-0000-000-00" /></div>{companyErrors.strn && <span className="text-xs text-danger mt-1">{companyErrors.strn}</span>}</div><div><label className="block text-xs font-semibold text-text-muted mb-1.5">CNIC</label><div className="relative group"><Hash className="absolute left-3 top-1/2 -translate-y-1/2 text-text-muted group-focus-within:text-primary transition-colors" size={16} /><input type="text" value={companyProfile.cnic || ''} onChange={(e) => handleCompanyChange('cnic', e.target.value)} className={`w-full bg-surface-highlight border ${companyErrors.cnic ? 'border-danger' : 'border-transparent'} rounded-xl py-2.5 pl-10 pr-4 text-text-main focus:outline-none focus:border-primary/30 font-mono text-sm`} placeholder="00000-0000000-0" /></div>{companyErrors.cnic && <span className="text-xs text-danger mt-1">{companyErrors.cnic}</span>}</div></div></div><div className="flex justify-end pt-4 border-t border-border"><button onClick={saveCompany} disabled={isSaving} className="flex items-center gap-2 px-6 py-2.5 rounded-xl bg-primary text-white font-medium hover:bg-primary-light shadow-lg shadow-primary/20 transition-all active:scale-95 disabled:opacity-70"><Save size={18} /> {isSaving ? (isFirstRun ? 'Initializing Database...' : 'Saving...') : (isFirstRun ? 'Create Company Database' : 'Save Profile')}</button></div></div></Card>)}
             {activeTab === 'users' && !isFirstRun && (<>{currentUser?.role === 'admin' ? (<div className="space-y-6"><div className="flex flex-col sm:flex-row items-start sm:items-center justify-between gap-4"><div><h2 className="text-xl font-bold text-text-main">User Management</h2><p className="text-sm text-text-muted mt-1">Manage system access and permissions.</p></div><button onClick={() => openUserModal()} className="flex items-center gap-2 bg-primary hover:bg-primary-light text-white px-5 py-2.5 rounded-xl font-medium shadow-lg shadow-primary/25 transition-all active:scale-95"><Plus size={18} /> Add User</button></div><div className="bg-surface rounded-2xl shadow-soft border border-border overflow-hidden"><div className="p-5 border-b border-border bg-surface/50 flex flex-col sm:flex-row gap-4 justify-between items-center"><div className="relative w-full sm:w-80 group"><Search className="absolute left-3 top-1/2 -translate-y-1/2 text-text-muted group-focus-within:text-primary transition-colors" size={16} /><input type="text" placeholder="Search users..." value={userSearch} onChange={(e) => setUserSearch(e.target.value)} className="w-full bg-surface-highlight border border-transparent rounded-xl py-2.5 pl-10 pr-4 text-sm text-text-main focus:border-primary/30 focus:outline-none focus:ring-4 focus:ring-primary/10 transition-all" /></div></div><div className="overflow-x-auto"><table className="w-full text-left text-sm"><thead className="bg-surface-highlight border-b border-border"><tr>{[{ key: 'name', label: 'User Details', w: '40%' }, { key: 'role', label: 'Role', w: '20%' }, { key: 'companyId', label: 'Database ID', w: '20%' }, { key: 'actions', label: 'Actions', w: '20%', align: 'right' }].map((col) => (<th key={col.key} className={`px-6 py-4 text-xs font-bold text-text-muted uppercase tracking-wider cursor-pointer hover:text-text-main transition-colors ${col.align === 'right' ? 'text-right' : ''}`} onClick={() => col.key !== 'actions' && handleUserSort(col.key as keyof DbUser)}><div className={`flex items-center gap-1 ${col.align === 'right' ? 'justify-end' : ''}`}>{col.label}{col.key !== 'actions' && userSortField === col.key && <ArrowUpDown size={12} className={userSortDirection === 'asc' ? 'rotate-0' : 'rotate-180'} />}</div></th>))}</tr></thead><tbody className="divide-y divide-border">{paginatedUsers.length === 0 ? (<tr><td colSpan={4} className="p-12 text-center text-text-muted">No users found.</td></tr>) : paginatedUsers.map((user) => (<tr key={user.id} className="hover:bg-surface-highlight transition-colors group"><td className="px-6 py-4"><div className="flex items-center gap-3"><img src={user.avatar || `https://ui-avatars.com/api/?name=${encodeURIComponent(user.name)}`} className="w-9 h-9 rounded-full border border-border" alt="" /><div><div className="font-semibold text-text-main">{user.name}</div><div className="text-xs text-text-muted">{user.email}</div></div></div></td><td className="px-6 py-4"><span className={`px-2.5 py-1 rounded-full text-xs font-bold uppercase tracking-wider border ${user.role === 'admin' ? 'border-primary/30 bg-primary/10 text-primary' : user.role === 'manager' ? 'border-accent/30 bg-accent/10 text-accent' : 'border-border bg-surface-highlight text-text-muted'}`}>{user.role}</span></td><td className="px-6 py-4 font-mono text-xs text-text-muted">{user.companyId || '-'}</td><td className="px-6 py-4 text-right"><div className="flex items-center justify-end gap-2 opacity-0 group-hover:opacity-100 transition-opacity"><button onClick={() => openUserModal(user)} className="p-2 text-blue-500 hover:bg-blue-500/10 rounded-lg"><Edit2 size={16} /></button>{user.id !== currentUser.id && (<button onClick={() => deleteUser(user.id)} className="p-2 text-danger hover:bg-danger/10 rounded-lg"><Trash2 size={16} /></button>)}</div></td></tr>))}</tbody></table></div>{totalUserPages > 1 && (<div className="p-4 border-t border-border flex items-center justify-between text-xs text-text-muted bg-surface/50"><span>Page {userPage} of {totalUserPages}</span><div className="flex gap-2"><button onClick={() => setUserPage(p => Math.max(1, p - 1))} disabled={userPage === 1} className="p-1.5 rounded-lg border border-border hover:bg-surface-highlight disabled:opacity-50 transition-colors"><ChevronLeft size={16} /></button><button onClick={() => setUserPage(p => Math.min(totalUserPages, p + 1))} disabled={userPage === totalUserPages} className="p-1.5 rounded-lg border border-border hover:bg-surface-highlight disabled:opacity-50 transition-colors"><ChevronRight size={16} /></button></div></div>)}</div></div>) : (<Card className="flex flex-col items-center justify-center h-64 text-center"><Lock size={40} className="text-danger mb-4 opacity-80" /><h3 className="text-text-main font-semibold text-lg">Access Denied</h3><p className="text-text-muted text-sm mt-1">You need administrator privileges to view this section.</p></Card>)}</>)}
             {activeTab === 'roles' && !isFirstRun && (<div className="space-y-6"><div><h2 className="text-xl font-bold text-text-main">Roles & Permissions</h2><p className="text-sm text-text-muted mt-1">Configure what each role can access in the system.</p></div>{/* ... */}</div>)}
             {activeTab === 'tax' && !isFirstRun && (<div className="space-y-6"><div className="flex flex-col sm:flex-row items-start sm:items-center justify-between gap-4"><div><h2 className="text-xl font-bold text-text-main">Tax Configuration</h2><p className="text-sm text-text-muted mt-1">Manage GST, WHT and other tax rates.</p></div><button onClick={() => openTaxModal()} className="flex items-center gap-2 bg-primary hover:bg-primary-light text-white px-5 py-2.5 rounded-xl font-medium shadow-lg shadow-primary/25 transition-all active:scale-95"><Plus size={18} /> Add Tax Rule</button></div>{/* ... */}<div className="overflow-x-auto"><table className="w-full text-left text-sm"><thead className="bg-surface-highlight border-b border-border"><tr><th className="px-6 py-4 text-xs font-bold text-text-muted uppercase">Name</th><th className="px-6 py-4 text-xs font-bold text-text-muted uppercase">Type</th><th className="px-6 py-4 text-xs font-bold text-text-muted uppercase">Rate</th><th className="px-6 py-4 text-xs font-bold text-text-muted uppercase">Status</th><th className="px-6 py-4 text-xs font-bold text-text-muted uppercase text-right">Actions</th></tr></thead><tbody className="divide-y divide-border">{taxes.map(t => (<tr key={t.id} className="group hover:bg-surface-highlight"><td className="px-6 py-4 font-medium">{t.name}</td><td className="px-6 py-4">{t.type}</td><td className="px-6 py-4">{t.rate}%</td><td className="px-6 py-4"><span className={`px-2 py-1 rounded text-xs font-bold ${t.status === 'Active' ? 'bg-success/10 text-success' : 'bg-danger/10 text-danger'}`}>{t.status}</span></td><td className="px-6 py-4 text-right"><div className="flex justify-end gap-2 opacity-0 group-hover:opacity-100"><button onClick={() => openTaxModal(t)} className="p-2 text-blue-500 hover:bg-blue-500/10 rounded"><Edit2 size={16}/></button><button onClick={() => deleteTax(t.id)} className="p-2 text-danger hover:bg-danger/10 rounded"><Trash2 size={16}/></button></div></td></tr>))}</tbody></table></div></div>)}
             {activeTab === 'chart_accounts' && !isFirstRun && (
               <div className="space-y-6">
                 <div className="flex flex-col sm:flex-row items-start sm:items-center justify-between gap-4 no-print">
                   <div className="relative flex-1 w-full max-w-md group">
                     <input type="text" placeholder="Search accounts..." value={coaSearch} onChange={(e) => setCoaSearch(e.target.value)} className="w-full bg-surface border border-border rounded-xl py-2.5 px-4 text-text-main focus:border-primary/30 focus:outline-none focus:ring-4 focus:ring-primary/10 transition-all shadow-soft" />
                   </div>
                   <div className="flex items-center gap-2 w-full sm:w-auto">
                     <button onClick={handlePrint} className="p-2.5 text-text-muted hover:text-text-main hover:bg-surface rounded-xl transition-colors border border-transparent hover:border-border"><Printer size={18} /></button>
                     <button onClick={handleExportCSV} className="p-2.5 text-text-muted hover:text-text-main hover:bg-surface rounded-xl transition-colors border border-transparent hover:border-border"><FileDown size={18} /></button>
                   </div>
                 </div>
                 
                 {/* Interactive Tree View - Hidden on Print */}
                 <div className="border border-border rounded-xl bg-surface overflow-hidden print:hidden">
                   <div className="grid grid-cols-12 bg-surface-highlight border-b border-border px-6 py-3 text-xs font-bold text-text-muted uppercase">
                     <div className="col-span-6">Account Code / Name</div>
                     <div className="col-span-2">Type</div>
                     <div className="col-span-2 text-right">Balance</div>
                     <div className="col-span-2 text-right">Actions</div>
                   </div>
                   <div className="max-h-[600px] overflow-y-auto">
                     {coa.sort((a,b) => a.code.localeCompare(b.code)).filter(c => c.name.toLowerCase().includes(coaSearch.toLowerCase()) || c.code.includes(coaSearch)).map(acc => {
                       if (acc.level > 1 && !expandedRows[acc.parentId || ''] && !coaSearch) return null;
                       const hasChildren = coa.some(c => c.parentId === acc.id);
                       return (
                         <div key={acc.id} className={`grid grid-cols-12 border-b border-border/50 hover:bg-surface-highlight/50 transition-colors py-2 px-6 items-center group ${acc.level === 1 ? 'bg-surface-highlight/20 font-semibold' : ''}`}>
                           <div className="col-span-6 flex items-center gap-2" style={{ paddingLeft: `${(acc.level - 1) * 20}px` }}>
                             {hasChildren ? (
                               <button onClick={() => toggleCoaRow(acc.id)} className="p-1 rounded hover:bg-surface-highlight text-text-muted no-print">
                                 {expandedRows[acc.id] ? <ChevronDown size={14}/> : <ChevronRight size={14}/>}
                               </button>
                             ) : <div className="w-6"></div>}
                             <span className="font-mono text-xs text-primary/80">{acc.code}</span>
                             <span className="text-sm text-text-main">{acc.name}</span>
                           </div>
                           <div className="col-span-2 text-xs text-text-muted">{acc.type}</div>
                           <div className="col-span-2 text-right text-sm font-mono">{acc.level === 4 ? acc.balance.toLocaleString() : '-'}</div>
                           <div className="col-span-2 flex justify-end gap-2 opacity-0 group-hover:opacity-100 transition-opacity">
                             {acc.level < 4 && <button onClick={() => openAddAccountModal(acc)} className="p-1.5 text-success hover:bg-success/10 rounded" title="Add Sub-Account"><Plus size={14}/></button>}
                             <button onClick={() => openEditAccountModal(acc)} className="p-1.5 text-blue-500 hover:bg-blue-500/10 rounded"><Edit2 size={14}/></button>
                             {!acc.isSystem && !hasChildren && <button onClick={() => deleteAccount(acc.id)} className="p-1.5 text-danger hover:bg-danger/10 rounded"><Trash2 size={14}/></button>}
                           </div>
                         </div>
                       );
                     })}
                   </div>
                 </div>

                 {/* Print-Only View: Full hierarchy without collapsing */}
                 <div className="hidden print:block border border-gray-300 rounded-xl overflow-hidden bg-white">
                    <div className="grid grid-cols-12 bg-gray-100 border-b border-gray-300 px-6 py-2 text-xs font-bold text-black uppercase">
                        <div className="col-span-8">Account Code / Name</div>
                        <div className="col-span-2">Type</div>
                        <div className="col-span-2 text-right">Balance</div>
                    </div>
                    <div>
                        {[...coa].sort((a,b) => a.code.localeCompare(b.code)).map(acc => (
                            <div key={acc.id} className={`grid grid-cols-12 border-b border-gray-200 py-1 px-6 items-center text-black ${acc.level === 1 ? 'font-bold bg-gray-50' : ''}`}>
                                <div className="col-span-8 flex items-center gap-2" style={{ paddingLeft: `${(acc.level - 1) * 20}px` }}>
                                    <span className="font-mono text-xs text-gray-600">{acc.code}</span>
                                    <span className="text-sm">{acc.name}</span>
                                </div>
                                <div className="col-span-2 text-xs">{acc.type}</div>
                                <div className="col-span-2 text-right text-sm font-mono">{acc.level === 4 ? acc.balance.toLocaleString() : ''}</div>
                            </div>
                        ))}
                    </div>
                 </div>

               </div>
             )}
          </div>
       </div>
       <Modal isOpen={isUserModalOpen} onClose={() => setIsUserModalOpen(false)} title={editingUser ? 'Edit User' : 'Create New User'}><div className="space-y-4"><div><label className="block text-xs font-semibold text-text-muted mb-1.5">Full Name</label><input type="text" value={userFormData.name} onChange={(e) => setUserFormData({...userFormData, name: e.target.value})} className={`w-full bg-surface-highlight border ${userFormErrors.name ? 'border-danger' : 'border-transparent'} rounded-xl py-2.5 px-4 text-text-main focus:outline-none focus:border-primary/30`} />{userFormErrors.name && <p className="text-xs text-danger mt-1">{userFormErrors.name}</p>}</div><div><label className="block text-xs font-semibold text-text-muted mb-1.5">Email</label><input type="email" value={userFormData.email} onChange={(e) => setUserFormData({...userFormData, email: e.target.value})} className={`w-full bg-surface-highlight border ${userFormErrors.email ? 'border-danger' : 'border-transparent'} rounded-xl py-2.5 px-4 text-text-main focus:outline-none focus:border-primary/30`} />{userFormErrors.email && <p className="text-xs text-danger mt-1">{userFormErrors.email}</p>}</div><div><label className="block text-xs font-semibold text-text-muted mb-1.5">Password {editingUser && <span className="text-text-muted font-normal">(Leave blank to keep current)</span>}</label><input type="password" value={userFormData.password} onChange={(e) => setUserFormData({...userFormData, password: e.target.value})} className={`w-full bg-surface-highlight border ${userFormErrors.password ? 'border-danger' : 'border-transparent'} rounded-xl py-2.5 px-4 text-text-main focus:outline-none focus:border-primary/30`} />{userFormErrors.password && <p className="text-xs text-danger mt-1">{userFormErrors.password}</p>}</div><div><label className="block text-xs font-semibold text-text-muted mb-1.5">Role</label><div className="flex gap-2">{(['admin', 'manager', 'user'] as Role[]).map(role => (<button key={role} onClick={() => setUserFormData({...userFormData, role})} className={`flex-1 py-2 rounded-xl text-sm capitalize transition-all ${userFormData.role === role ? 'bg-primary text-white shadow-md' : 'bg-surface-highlight text-text-muted hover:bg-surface-highlight/80'}`}>{role}</button>))}</div></div>{!editingUser && (<div className="p-3 bg-primary/5 rounded-lg border border-primary/10 text-xs text-text-muted">Note: This user will automatically be assigned to the current organization database <strong>({currentUser?.companyId})</strong>.</div>)}<div className="flex justify-end gap-3 pt-4"><button onClick={() => setIsUserModalOpen(false)} className="px-4 py-2 text-sm text-text-muted hover:text-text-main">Cancel</button><button onClick={saveUser} className="bg-primary text-white px-6 py-2 rounded-xl text-sm font-medium hover:bg-primary-light shadow-lg shadow-primary/20">Save User</button></div></div></Modal>
       <Modal isOpen={isTaxModalOpen} onClose={() => setIsTaxModalOpen(false)} title={editingTax ? 'Edit Tax Setting' : 'Add New Tax'}><div className="space-y-4"><div><label className="block text-xs font-semibold text-text-muted mb-1.5">Tax Name</label><input type="text" value={taxFormData.name || ''} onChange={e => setTaxFormData({...taxFormData, name: e.target.value})} className="w-full bg-surface-highlight border border-transparent rounded-xl py-2.5 px-4 text-text-main focus:outline-none focus:border-primary/30" placeholder="e.g. Standard GST" /></div><div><label className="block text-xs font-semibold text-text-muted mb-1.5">Tax Type</label><select value={taxFormData.type || 'GST'} onChange={e => setTaxFormData({...taxFormData, type: e.target.value as TaxType})} className="w-full bg-surface-highlight border border-transparent rounded-xl py-2.5 px-4 text-text-main focus:outline-none focus:border-primary/30"><option>GST</option><option>WHT</option><option>Income Tax</option></select></div><div><label className="block text-xs font-semibold text-text-muted mb-1.5">Rate (%)</label><input type="number" value={taxFormData.rate || ''} onChange={e => setTaxFormData({...taxFormData, rate: Number(e.target.value)})} className="w-full bg-surface-highlight border border-transparent rounded-xl py-2.5 px-4 text-text-main focus:outline-none focus:border-primary/30" /></div><div><label className="block text-xs font-semibold text-text-muted mb-1.5">Status</label><select value={taxFormData.status || 'Active'} onChange={e => setTaxFormData({...taxFormData, status: e.target.value as any})} className="w-full bg-surface-highlight border border-transparent rounded-xl py-2.5 px-4 text-text-main focus:outline-none focus:border-primary/30"><option>Active</option><option>Inactive</option></select></div><div className="flex justify-end gap-3 pt-4"><button onClick={() => setIsTaxModalOpen(false)} className="px-4 py-2 text-sm text-text-muted hover:text-text-main">Cancel</button><button onClick={saveTax} className="bg-primary text-white px-6 py-2 rounded-xl text-sm font-medium hover:bg-primary-light shadow-lg shadow-primary/20">Save Tax</button></div></div></Modal>
       <Modal isOpen={isCoaModalOpen} onClose={() => setIsCoaModalOpen(false)} title={editingAccount ? 'Edit Account' : 'Add New Account'}><div className="space-y-4"><div><label className="block text-xs font-semibold text-text-muted mb-1.5">Account Name <span className="text-danger">*</span></label><input type="text" value={accountFormData.name} onChange={e => setAccountFormData({...accountFormData, name: e.target.value})} onBlur={e => setAccountFormData({...accountFormData, name: toProperCase(e.target.value)})} className="w-full bg-surface-highlight border border-transparent rounded-xl py-2.5 px-4 text-text-main focus:outline-none focus:border-primary/30" placeholder="e.g. Petty Cash" /></div><div><label className="block text-xs font-semibold text-text-muted mb-1.5">Description</label><textarea rows={3} value={accountFormData.description} onChange={e => setAccountFormData({...accountFormData, description: e.target.value})} className="w-full bg-surface-highlight border border-transparent rounded-xl py-2.5 px-4 text-text-main focus:outline-none focus:border-primary/30 resize-none" /></div>{newAccountParent && (<div className="bg-primary/5 p-3 rounded-lg border border-primary/10 text-xs text-text-muted">Adding sub-account under <span className="font-bold text-primary">{newAccountParent.name} ({newAccountParent.code})</span>.<br/>The new code will be auto-generated.</div>)}<div className="flex justify-end gap-3 pt-4"><button onClick={() => setIsCoaModalOpen(false)} className="px-4 py-2 text-sm text-text-muted hover:text-text-main">Cancel</button><button onClick={saveAccount} className="bg-primary text-white px-6 py-2 rounded-xl text-sm font-medium hover:bg-primary-light shadow-lg shadow-primary/20">Save Account</button></div></div></Modal>
    </div>
  );
};
export default Settings;
